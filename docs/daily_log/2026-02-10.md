# 2026-02-10 (월) — Shell 라우터 실기능 전환 + 5대 미완 구현 + 전체 플랫폼 고도화

---

## 1. 4개 Shell 라우터 실기능 전환 `e51a087`

**4파일 변경 (+815 / -47)**

이전 자체감사에서 "껍데기"로 판별된 4개 라우터를 실제 동작하도록 전면 교체했다.

### gov_lineage_ext.py (306→591줄)
| 변경 | 내용 |
|------|------|
| sqlglot SQL 파싱 | `POST /lineage/parse-sql` — AST에서 테이블/컬럼/리니지 추출 |
| 동적 FK 탐색 | `information_schema.table_constraints` 기반 38개 FK + 22개 정적 = **60 edges** |
| 쿼리 영향분석 | `POST /lineage/query-impact` — SQL 의존성 분석 + 하류 BFS |
| lineage_log 테이블 | 파싱된 SQL 리니지 결과 DB 영속화 |

### cdc_executor.py (350→493줄)
| 변경 | 내용 |
|------|------|
| 동적 PK 탐지 | `information_schema.key_column_usage`에서 실제 PK 컬럼 조회 (하드코딩 `person_id` 제거) |
| pg_notify | 트리거 함수에 `PERFORM pg_notify('cdc_{table}', payload)` 추가 → 실시간 알림 |
| SSE 리스너 | `GET /configs/{id}/listen` — asyncpg LISTEN/NOTIFY + StreamingResponse |

### mart_recommend.py (666→782줄)
| 변경 | 내용 |
|------|------|
| mart_usage_log | 사용 이력 테이블 신규 생성 (view/preview/create/export 추적) |
| 3단계 추천 | 인기도×0.4 + 협업필터링×0.4 + 카테고리×0.2 (기존: 카테고리 top 3 반환) |
| SQL injection 수정 | f-string 보간 → parameterized query (`$1, $2, ...`) |

### ai_safety.py (608→828줄)
| 변경 | 내용 |
|------|------|
| 패턴 확장 | 13개 → **37개** (OWASP prompt injection + 한국어 우회 패턴) |
| 이상탐지 | Shannon 엔트로피 + n-gram(12개) + 특수문자 비율 + 입력 길이 분석 |
| 통합 scan | `POST /scan` — injection + PII + harmful SQL 한번에 검사 → risk_score 0-100 |
| 동적 의료코드 캐시 | 하드코딩 dict 8개 → condition_occurrence 상위 100개 DB 조회 |

### 검증 결과
- parse-sql: 테이블 2개 + 컬럼 3개 정상 추출 (sqlglot 28.10.1)
- scan: "ignore previous instructions + DROP TABLE" → risk_score **60** (high)
- recommend: 3단계 알고리즘 동작, 당뇨·고혈압·다제약물 마트 반환
- CDC: care_site 테이블 트리거 설치, PK `care_site_id` 자동 탐지

---

## 2. 전체 플랫폼 고도화 `cbf3c9b`

**53파일 변경 (+6,706 / -1,686)**

### 신규 백엔드 (3파일)
| 파일 | 줄 수 | 기능 |
|------|-------|------|
| `chat_db.py` | 367 | 채팅 세션 DB 영속화 라우터 |
| `unstructured.py` | 658 | 비정형 데이터 처리 라우터 |
| `biz_meta_generator.py` | 375 | 비즈니스 메타 자동 생성 서비스 |

### 백엔드 개선 (24파일)
| 영역 | 주요 변경 |
|------|-----------|
| AI Ops | `_ai_ops_shared.py` 대폭 확장 (+681줄), audit/safety 라우터 개선 |
| AI 환경 | containers/notebooks/projects/resources/shared 강화 |
| 채팅 | chat_core 리팩토링 (-261줄), helpers/streaming 개선 |
| ETL | airflow 프록시 개선, shared 수정 |
| 거버넌스 | sensitivity 분석 리팩토링 |
| 메타관리 | mappings 개선 |
| 포털 운영 | home 대시보드 개선 |

### 프론트엔드 리팩토링 (14파일)
| 변경 | 내용 |
|------|------|
| MainLayout 분리 | `ResultsOverlay.tsx`(123줄) + `layoutConstants.ts`(136줄) 추출 |
| AIAssistantPanel 분리 | `ChatHistoryModal.tsx`(193줄) + `buildThinkingSteps.ts`(105줄) + `chatConstants.ts`(76줄) 추출 |
| TableDetailModal 분리 | `tableDetailHelpers.tsx`(74줄) 추출 |
| MedicalNER | 대폭 개선 (+826줄) — 임상노트 구조화, DICOM 파싱, 처리 이력 |

### 문서
- 제안발표 PDF v0.72 / v1.0 추가
- AI QA 제안발표 문서 추가
- 일별 작업 로그 (2/2, 2/6, 2/7, 2/8, 2/9) 정리
- 데모 스크립트, 개발 통계 업데이트

---

## 3. .gitignore 업데이트 `576f0f1`

**1파일 변경 (+1)**

- `infra/backups/` 추가 (DB 덤프 2.4GB 제외)

---

## 4. 5대 미완 항목 구현

이전 자체평가에서 "미완/한계"로 분류된 5개 항목을 전부 구현했다.

| 항목 | 구현 내용 | 검증 결과 |
|------|----------|----------|
| **DuckDB OLAP** | `lakehouse.py` — OMOP CDM PostgreSQL ATTACH (postgres extension), `/duckdb/status` + `/duckdb/query` | 30 테이블 ATTACH, `SELECT count(*) FROM person` → 76,074건 (42ms) |
| **Redis 3-tier 캐시** | `portal_ops_home.py`, `ontology_data.py`, `catalog_analytics.py` — Redis→모듈dict→DB 3단계 | portal-ops 대시보드 캐시 적중 확인 |
| **KeyCloak SSO** | `auth_core.py` — `/sso/login` (OIDC URL), `/sso/callback` (토큰 교환 + JWT 발급), `/sso/status` | 서버 연결 확인, `asan` realm 설정 필요 |
| **Neo4j Docker** | `docker-compose.yml` + `ontology_data.py` — `/neo4j-push` + `/neo4j-status` | 171노드 + 260엣지 OMOP 그래프, Bolt 연결 확인 |
| **Multi-Worker** | `main.py` — `PRODUCTION=true` → uvicorn workers=4 (기존 구현 확인) | 코드 확인 완료 |

---

## 전체 라우터 감사 결과

129개 라우터 파일 전수 조사 완료:

| 분류 | 개수 |
|------|------|
| 실제 동작 라우터 | **76개** (asyncpg DB / 외부 서비스 / Docker) |
| Umbrella 라우터 (sub-router 묶음) | 22개 |
| Shared 모듈 (헬퍼/모델) | 31개 |
| 껍데기 | **0개** |
