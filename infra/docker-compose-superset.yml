x-superset-image: &superset-image apache/superset:3.1.0

x-superset-depends-on: &superset-depends-on
  - superset-db
  - superset-redis

x-superset-volumes: &superset-volumes
  - ./superset/docker:/app/docker
  - ./superset/docker/superset_config.py:/app/pythonpath/superset_config.py
  - superset_home:/app/superset_home

services:
  superset-db:
    image: postgres:15
    container_name: superset-db
    environment:
      POSTGRES_USER: superset
      POSTGRES_PASSWORD: superset
      POSTGRES_DB: superset
    ports:
      - "15432:5432"
    volumes:
      - superset-db-volume:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "superset"]
      interval: 10s
      retries: 5
      start_period: 5s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.50'

  superset-redis:
    image: redis:7-alpine
    container_name: superset-redis
    restart: unless-stopped
    volumes:
      - superset-redis-volume:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'

  superset:
    image: *superset-image
    container_name: superset
    command: ["/app/docker/docker-bootstrap.sh", "app-gunicorn"]
    environment:
      DATABASE_HOST: superset-db
      DATABASE_PORT: 5432
      DATABASE_USER: superset
      DATABASE_PASSWORD: superset
      DATABASE_DB: superset
      REDIS_HOST: superset-redis
      REDIS_PORT: 6379
      SUPERSET_SECRET_KEY: "asan-idp-superset-secret-key-2026"
      SUPERSET_LOAD_EXAMPLES: "no"
      SUPERSET_CONFIG_PATH: /app/pythonpath/superset_config.py
    ports:
      - "18088:8088"
    depends_on: *superset-depends-on
    volumes: *superset-volumes
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default
      - infra_default
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.00'

  superset-init:
    image: *superset-image
    container_name: superset-init
    command: ["/app/docker/docker-init.sh"]
    environment:
      DATABASE_HOST: superset-db
      DATABASE_PORT: 5432
      DATABASE_USER: superset
      DATABASE_PASSWORD: superset
      DATABASE_DB: superset
      REDIS_HOST: superset-redis
      REDIS_PORT: 6379
      SUPERSET_SECRET_KEY: "asan-idp-superset-secret-key-2026"
      SUPERSET_CONFIG_PATH: /app/pythonpath/superset_config.py
      ADMIN_USERNAME: admin
      ADMIN_PASSWORD: admin
      ADMIN_EMAIL: admin@asan.org
      ADMIN_FIRSTNAME: Admin
      ADMIN_LASTNAME: User
    depends_on: *superset-depends-on
    volumes: *superset-volumes

  superset-worker:
    image: *superset-image
    container_name: superset-worker
    command: ["/app/docker/docker-bootstrap.sh", "worker"]
    environment:
      DATABASE_HOST: superset-db
      DATABASE_PORT: 5432
      DATABASE_USER: superset
      DATABASE_PASSWORD: superset
      DATABASE_DB: superset
      REDIS_HOST: superset-redis
      REDIS_PORT: 6379
      SUPERSET_SECRET_KEY: "asan-idp-superset-secret-key-2026"
      SUPERSET_CONFIG_PATH: /app/pythonpath/superset_config.py
    depends_on: *superset-depends-on
    volumes: *superset-volumes
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "celery -A superset.tasks.celery_app:app inspect ping -d celery@$$HOSTNAME"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.00'

  superset-beat:
    image: *superset-image
    container_name: superset-beat
    command: ["bash", "-c", "rm -f /tmp/celerybeat.pid && /app/docker/docker-bootstrap.sh beat"]
    environment:
      DATABASE_HOST: superset-db
      DATABASE_PORT: 5432
      DATABASE_USER: superset
      DATABASE_PASSWORD: superset
      DATABASE_DB: superset
      REDIS_HOST: superset-redis
      REDIS_PORT: 6379
      SUPERSET_SECRET_KEY: "asan-idp-superset-secret-key-2026"
      SUPERSET_CONFIG_PATH: /app/pythonpath/superset_config.py
    depends_on: *superset-depends-on
    volumes: *superset-volumes
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.50'

  superset-omop-init:
    image: *superset-image
    container_name: superset-omop-init
    command: ["bash", "-c", "pip install requests && python /app/docker/init-omop-dashboards.py"]
    environment:
      SUPERSET_URL: "http://superset:8088"
      ADMIN_USERNAME: admin
      ADMIN_PASSWORD: admin
      OMOP_DB_HOST: omop-db
      OMOP_DB_PORT: 5432
      OMOP_DB_NAME: omop_cdm
      OMOP_DB_USER: omopuser
      OMOP_DB_PASS: omop
    depends_on:
      superset:
        condition: service_healthy
    volumes:
      - ./superset/docker:/app/docker
    networks:
      - default
      - infra_default

volumes:
  superset-db-volume:
  superset-redis-volume:
  superset_home:

networks:
  infra_default:
    external: true
