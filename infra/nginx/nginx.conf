events {
    worker_connections 1024;
}

http {
    # ── 공통 보안 헤더 ──
    # OWASP 권장 + SER-004 요구사항 반영
    add_header X-Content-Type-Options  "nosniff" always;
    add_header X-XSS-Protection        "1; mode=block" always;
    add_header Referrer-Policy          "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy       "geolocation=(), microphone=(), camera=()" always;

    # Gzip 압축
    gzip on;
    gzip_types text/plain application/json application/javascript text/css;
    gzip_min_length 256;

    # API 로드밸런서 (HA용 — 현재 단일 인스턴스, 확장 시 추가)
    upstream idp_api {
        least_conn;
        server host.docker.internal:8000;
        # 이중화 시 아래 주석 해제:
        # server host.docker.internal:8001;
    }

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=30r/s;
    limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=5r/s;

    # ── HTTPS API 프록시 (메인 진입점) ──
    server {
        listen 443 ssl;
        server_name localhost;

        ssl_certificate     /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;
        ssl_protocols       TLSv1.2 TLSv1.3;
        ssl_ciphers         HIGH:!aNULL:!MD5:!RC4;
        ssl_prefer_server_ciphers on;
        ssl_session_cache   shared:SSL:10m;
        ssl_session_timeout 10m;

        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-Frame-Options "DENY" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'self' https://localhost:* http://localhost:*; font-src 'self' data:;" always;

        # 인증 엔드포인트 — 별도 rate limit (5r/s)
        location /api/v1/auth/ {
            limit_req zone=auth_limit burst=10 nodelay;
            proxy_pass http://idp_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
        }

        location /api/ {
            limit_req zone=api_limit burst=50 nodelay;
            proxy_pass http://idp_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_connect_timeout 5s;
            proxy_read_timeout 30s;
            proxy_send_timeout 10s;
        }

        location /api/v1/health {
            proxy_pass http://idp_api;
            proxy_set_header Host $host;
        }
    }

    # ── HTTP API 프록시 (기존 호환 — HTTP→HTTPS 리다이렉트 권장) ──
    server {
        listen 18082;
        server_name localhost;

        location /api/ {
            limit_req zone=api_limit burst=50 nodelay;
            proxy_pass http://idp_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 5s;
            proxy_read_timeout 30s;
            proxy_send_timeout 10s;
        }

        location /api/v1/health {
            proxy_pass http://idp_api;
            proxy_set_header Host $host;
        }
    }

    # Airflow proxy - iframe 임베딩용 (SAMEORIGIN)
    server {
        listen 18081;
        server_name localhost;

        location / {
            proxy_pass http://host.docker.internal:18080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
            add_header X-Frame-Options "SAMEORIGIN" always;
        }
    }

    # JupyterLab proxy - iframe 임베딩용 (SAMEORIGIN)
    server {
        listen 18889;
        server_name localhost;

        location / {
            proxy_pass http://host.docker.internal:18888;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_read_timeout 86400;

            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
            add_header X-Frame-Options "SAMEORIGIN" always;
        }
    }
}
